name: Docker Image CI

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: photobooth-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ§ª Test image
        run: |
          # Start container
          docker run -d \
            --name photobooth-test \
            -p 3000:3000 \
            -e NODE_ENV=production \
            photobooth-server:test

          # Wait for startup
          echo "Waiting for application to start..."
          sleep 10

          # Health check
          echo "Testing health endpoint..."
          curl -f http://localhost:3000/api/health || exit 1

          # Check logs
          echo "Container logs:"
          docker logs photobooth-test

          # Cleanup
          docker stop photobooth-test
          docker rm photobooth-test

      - name: ğŸ” Scan for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: photobooth-server:test
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: âœ… Tests passed
        run: echo "All tests passed successfully!"
